{% extends "web/base.html" %}
{% load static %}
{% block title %} - Sorteo{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'sorteo/style.css' %}">
<div class="fondo" style="background-image: url({% static 'sorteo/background-explicacion.jpg' %})"></div>
<div class="contenedor">    
    <div class="row align-items-center">
        <div class="col-2 d-none d-md-block">
            <h2 class="letras">QbaRed</h2>
            <img id="medio" class="rounded-circle" width="30%" src="{% static 'sorteo/coin.gif' %}" alt="coins"/>
            <h2 class="letras">200</h2>
            <img id="medio" class="rounded-circle" width="40%" src="{% static 'sorteo/coin.gif' %}" alt="coins"/>
            <h2 class="letras">coins</h2>
            <img id="medio" class="rounded-circle" width="50%" src="{% static 'sorteo/coin.gif' %}" alt="coins"/>
            <h2 class="letras">200</h2>
            <img id="medio" class="rounded-circle" width="20%" src="{% static 'sorteo/coin.gif' %}" alt="coins"/>
            <h2 class="letras">coins</h2>
            <img id="medio" class="rounded-circle" width="40%" src="{% static 'sorteo/coin.gif' %}" alt="coins"/>
            <h2 class="letras">200</h2>
        </div>
        <div class="col-12 col-md-8 mainframe">
            <div class="row align-items-center ">
                <div class="col-12 order-2 col-md-8 order-md-1">
                    <h1 class="letras">Participantes</h1>
                    <div class="participants-frame">  
                        <div class="spinner-grow text-dark" role="status" aria-hidden="true" id="spinner"></div>          
                        <ul class="participants-list">
                        </ul>         
                    </div>
                </div>
                <div class="col-12 order-1 col-md-4 order-md-2 frame">
                    <h1 class="letras">Suerte!!!</h1>
                    <h3 class="letras">Los verdes están activos</h3>                    
                    <img class="img-fluid" src="{% static 'sorteo/middle.gif' %}" alt="mmmm"/>
                    <h3 class="letras">Los rojos están eliminados</h3>        
                    <div id="botones">
                        {% if usuario.is_staff %}
                        <button id="roll-button" class="btn btn-success" style="float: right;">
                            Empezar
                        </button>                        
                        {% endif %}
                    </div>
                </div>
            </div> 
            <div class="row result">
                <h1 id="resultado">Sorteo Finalizado{{ text }}</h1>
            </div>
        </div>
        <div class="col-2 d-none d-md-block">
            <h2 class="letras">QbaRed</h2>
            <img id="medio" class="rounded-circle" width="30%" src="{% static 'sorteo/coin.gif' %}" alt="coins"/>
            <h2 class="letras">200</h2>
            <img id="medio" class="rounded-circle" width="20%" src="{% static 'sorteo/coin.gif' %}" alt="coins"/>
            <h2 class="letras">coins</h2>
            <img id="medio" class="rounded-circle" width="50%" src="{% static 'sorteo/coin.gif' %}" alt="coins"/>
            <h2 class="letras">200</h2>
            <img id="medio" class="rounded-circle" width="40%" src="{% static 'sorteo/coin.gif' %}" alt="coins"/>
            <h2 class="letras">coins</h2>
            <img id="medio" class="rounded-circle" width="30%" src="{% static 'sorteo/coin.gif' %}" alt="coins"/>
            <h2 class="letras">200</h2>            
        </div>        
    </div>
</div>
{{ activo|json_script:"activo" }}
{{ finalizado|json_script:"finalizado" }}
<script src="{% static 'sorteo/reconnecting-websocket.js' %}"></script> 
<script>
    const activos = [];
    const eliminados = [];
    var activo = JSON.parse(document.getElementById('activo').textContent);
    var finalizado = JSON.parse(document.getElementById('finalizado').textContent);
    var socket = new ReconnectingWebSocket('ws://172.16.0.10:8000/ws/sorteo/running/');
    socket.onopen = function(e) {
        console.log('socket conectado');
        if (activo === false) {
            socket.send(JSON.stringify({
                'command': 'participants'
            })) 
        };
        if (finalizado === true) {
            resultado.classList.add("letras")
            document.querySelector('.frame').classList.add("playframe");
            document.querySelector('.result').classList.add("playresult");
        }   
    }
    socket.onmessage = function(e){
        var data = JSON.parse(e.data);
        if (data['code'] === 'Ya ha terminado el sorteo') {
            var resultado = document.querySelector('#resultado');
            resultado.innerText = data.code;
            resultado.classList.add("letras")
            document.querySelector('.frame').classList.add("playframe");
            document.querySelector('.result').classList.add("playresult"); 
            activo = false;          
        } else if (data['command'] === 'participants') {            
            var list = document.querySelector('.participants-list');
            while (list.firstChild) {
                list.removeChild(list.firstChild);
            }
            document.getElementById('spinner').style.display = 'none';
            document.querySelector('.frame').classList.remove("playframe");
            document.querySelector('.result').classList.remove("playresult");
            var participants = data['participants']
            var participants = participants.map(participants => {                   
                var parListTag = document.createElement('li');
                if (participants['eliminado']) {
                    var delTag = document.createElement('del');
                    delTag.textContent = participants['usuario'] + ", servicio: " + participants['servicio'] + " code: " + participants['code'];
                    parListTag.appendChild(delTag);
                    parListTag.className = "dead";
                    parListTag.id = participants.id
                    eliminados.push(participants.id);
                } else {
                    var pTag = document.createElement('p');
                    pTag.textContent = participants['usuario'] + ", servicio: " + participants['servicio'] + " code: " + participants['code'];
                    parListTag.appendChild(pTag);
                    parListTag.className = "alive";
                    parListTag.id = participants.id
                    activos.push(participants.id);
                }                        
                document.querySelector('.participants-list').appendChild(parListTag);
            });
            /* if (activo === true) {
                setTimeout(roll, 3000);
                function roll() {
                    socket.send(JSON.stringify({
                        'command': 'roll'
                    }))
                };
            } */          
        } else {
            var resultado = document.querySelector('#resultado');
            resultado.innerText = data.code;
            resultado.classList.add("letras")
            document.querySelector('.frame').classList.add("playframe");
            document.querySelector('.result').classList.add("playresult");
            setTimeout(enviar, 3000);
            function enviar() {
                socket.send(JSON.stringify({
                    'command': 'participants'
                }))
            };
        }
    }
    socket.onclose = function(e) {
        console.error('socket cerrado');
    }
    document.querySelector('#roll-button').onclick = function(e) {
        activo = true;
        socket.send(JSON.stringify({
            'command': 'start'
        }));
        socket.send(JSON.stringify({
            'command': 'roll'
        }))
    }    
</script>
{% endblock content %}